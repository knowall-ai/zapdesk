= ZapDesk Solution Design
:toc: left
:toclevels: 3
:icons: font

== Overview

ZapDesk is a customer support ticketing portal that provides a Zendesk-like experience while using Azure DevOps as the backend work item management system. This enables organizations to manage customer support requests alongside their development work.

== Architecture

=== High-Level Architecture

[source]
----
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│   Client        │────▶│   ZapDesk       │────▶│   Azure DevOps  │
│   (Browser)     │     │   (Next.js)     │     │   REST API      │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               │
                               │
                        ┌──────▼──────┐
                        │             │
                        │  Azure AD   │
                        │  (Auth)     │
                        │             │
                        └─────────────┘
----

=== Technology Stack

[cols="1,2"]
|===
|Component |Technology

|Frontend
|Next.js 15 (App Router), React 19, TypeScript

|Styling
|Tailwind CSS with CSS Variables

|Authentication
|NextAuth.js with Azure AD Provider

|Backend API
|Azure DevOps REST API v7.0

|Deployment
|Azure App Service

|Email Integration
|Webhook endpoint for email providers
|===

== Authentication Flow

=== OAuth 2.0 with Azure AD

[source]
----
1. User clicks "Sign in with Microsoft"
2. Redirect to Azure AD authorization endpoint
3. User authenticates and consents
4. Azure AD redirects back with authorization code
5. NextAuth exchanges code for tokens
6. Access token includes Azure DevOps scope
7. Token stored in encrypted JWT session
----

=== Required Scopes

* `openid` - OpenID Connect
* `profile` - User profile
* `email` - Email address
* `offline_access` - Refresh tokens
* `499b84ac-1321-427f-aa17-267ca6975798/.default` - Azure DevOps API

== Data Model

=== Mapping to Azure DevOps

[cols="1,1,2"]
|===
|ZapDesk Concept |DevOps Entity |Notes

|Ticket
|Work Item
|Must have "ticket" tag

|Organization
|Project
|One project per client

|Customer
|Identity
|Work item creator/requester

|Status
|Work Item State
|Mapped to Zendesk-like statuses

|Priority
|Priority Field
|1=Urgent, 2=High, 3=Normal, 4=Low
|===

=== Status Mapping

[cols="1,1"]
|===
|Azure DevOps State |ZapDesk Status

|New
|New

|Active
|Open

|In Progress / Doing
|In Progress

|Pending / On Hold
|Pending

|Resolved
|Resolved

|Closed / Done
|Closed
|===

== API Design

=== Internal API Routes

[cols="1,1,2"]
|===
|Endpoint |Method |Description

|`/api/auth/*`
|Various
|NextAuth.js authentication endpoints

|`/api/devops/tickets`
|GET
|List tickets with filtering

|`/api/devops/tickets/[id]`
|GET
|Get single ticket details

|`/api/devops/tickets/[id]/comments`
|POST
|Add comment to ticket

|`/api/devops/tickets/[id]/status`
|PATCH
|Update ticket status

|`/api/devops/stats`
|GET
|Dashboard statistics

|`/api/devops/organizations`
|GET
|List organizations (projects)

|`/api/devops/customers`
|GET
|List customers

|`/api/email/webhook`
|POST
|Email-to-ticket creation
|===

== Security Considerations

=== Authentication

* All API routes require authenticated session
* JWT tokens encrypted with NEXTAUTH_SECRET
* Token refresh handled automatically

=== Authorization

* Users only see tickets from projects they have access to
* Azure DevOps permissions are respected
* No data stored locally - all from DevOps

=== Email Webhook

* Protected by shared secret header
* Validates sender domain for project mapping
* Rate limiting recommended at infrastructure level

== Multi-Tenant Design

=== Project-Based Tenancy

Each client organization has:

* Dedicated Azure DevOps project
* Domain mapping for email integration
* SLA tags for service level differentiation

=== Domain Mapping

[source,typescript]
----
const PROJECT_DOMAIN_MAP = {
  'cairnhomes.com': 'Cairn Homes',
  'medite.com': 'Medite',
  'knowall.ai': 'KnowAll',
};
----

== Feature Block Explorer

=== Overview

The Feature Block Explorer is a mempool.space-inspired visualization that displays work items within a Feature as colored blocks. It provides an at-a-glance view of work item distribution, priority, and effort.

=== Visual Design

Inspired by https://mempool.space[mempool.space] "Goggles" visualization:

* **Grid-based layout**: Work items are packed into a grid using a first-fit bin-packing algorithm
* **No text on blocks**: Clean appearance with details shown on hover tooltip
* **Bottom-aligned**: Blocks align to the bottom of the container (gravity effect)
* **Fixed gaps**: 4px gaps between blocks for visual separation
* **Priority-based coloring**: Green gradient from bright (Urgent) to dark (Low)

=== Block Sizing

Block sizes are determined by logged hours using absolute thresholds:

[cols="1,1,1"]
|===
|Hours Range |Grid Size |Area (relative)

|0 - 0.25h
|1×1
|1

|0.25 - 0.5h
|1×1
|1

|0.5 - 1h
|2×2
|4 (4× smallest)

|1 - 2h
|3×3
|9

|2 - 4h
|4×4
|16

|4 - 6h
|6×6
|36

|6 - 8h
|8×8
|64 (4× of 2-4h)

|8h+
|16×16
|256 (4× of 6-8h)
|===

=== Priority Colors

Using KnowAll brand green palette:

[cols="1,1,2"]
|===
|Priority |Color |Hex

|Urgent
|Brightest green
|`#4ade80`

|High
|Primary green
|`#22c55e`

|Normal
|Medium green
|`#16a34a`

|Low
|Dark green
|`#15803d`

|Not set
|Very dark green
|`#0f5132`
|===

=== Work Item Filtering

The Explorer only displays "leaf" work items. Container types are excluded:

* User Story
* Feature
* Epic

This ensures the visualization shows actionable work items (Tasks, Bugs, etc.) rather than hierarchical containers.

=== Layout Behavior

Blocks are laid out using bin-packing and bottom-aligned:

* Blocks maintain their size based on hours (no scaling)
* Blocks fill from bottom-left, going right then up
* Empty space appears at the top when fewer/smaller items
* The visual fill naturally reflects the work logged

=== Implementation

The visualization is implemented in `src/components/visualization/FeatureBlockchain.tsx`:

* `layoutBlocks()` - Grid-based bin-packing algorithm
* `getPriorityColor()` - Priority to color mapping
* `isLeafWorkItem()` - Filters container types
* SVG rendering with hover tooltips

=== Tooltip Information

Hovering over a block shows:

* Work item title
* ID, type, and state
* Priority level
* Total hours logged

== Future Enhancements

* Real-time updates via WebSocket/SSE
* CSAT (Customer Satisfaction) surveys
* SLA timer visualization
* Bulk ticket operations
* Custom views and saved filters
* Reporting dashboard
* Mobile responsive improvements
